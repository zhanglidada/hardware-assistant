# 云数据库配置与调试指南

> 微信云数据库集成与问题排查完整指南

## 概述

硬件助手使用**微信云数据库**作为主数据源，**本地 Mock 数据**作为降级方案，确保应用在任何情况下都能正常使用。

## 云数据库配置

### 1. 创建云环境

在微信开发者工具中：

1. 打开云开发控制台
2. 点击「新建云环境」
3. 记录云环境 ID（例如：`cloud1-1gqg24ni14cea8dd`）

### 2. 初始化云环境

在 [src/App.vue](../../src/App.vue) 的 `onLaunch` 或 `onShow` 中初始化：

```typescript
wx.cloud.init({
  traceUser: true,
  env: 'cloud1-1gqg24ni14cea8dd' // 替换为你的云环境 ID
})
```

### 3. 创建数据库集合

在云开发控制台创建以下集合：

| 集合名称 | 用途 | 权限设置 |
|---------|------|---------|
| `cpu_collection` | CPU 数据存储 | 所有用户可读 |
| `gpu_collection` | GPU 数据存储 | 所有用户可读 |
| `phone_collection` | 手机数据存储 | 所有用户可读 |

### 4. 配置集合权限

对于每个集合：
1. 点击集合名称
2. 进入「权限设置」
3. 选择「所有用户可读，仅创建者可写」

### 5. 添加索引（可选，提升性能）

推荐索引：
- `id` - 唯一索引
- `brand` - 普通索引
- `model` - 普通索引
- `releaseDate` - 普通索引

## 数据导入

### 方法1：使用数据管道脚本

```bash
# 进入脚本目录
cd skills/scripts

# 运行数据更新脚本
python update_db.py
```

脚本会：
1. 运行数据采集器
2. 清洗和格式化数据
3. 生成 JSONL 文件
4. 提示手动导入到云数据库

### 方法2：手动导入

1. 在云控制台选择对应集合
2. 点击「导入」按钮
3. 选择 `src/mock/` 下的 JSON 文件
4. 确认导入

### 方法3：使用云控制台直接添加

适用于测试少量数据：
1. 选择集合
2. 点击「添加记录」
3. 粘贴 JSON 数据
4. 保存

## 数据访问架构

### Read-Through 缓存策略

```
用户请求
  ↓
useCloudData Hook
  ↓
检查云开发环境
  ├─ 可用 → 查询云数据库
  │          ├─ 成功 → 返回数据
  │          └─ 失败 → 降级到本地
  └─ 不可用 → 降级到本地
             ↓
        返回本地 Mock 数据 + Toast 提示
```

### 降级触发条件

自动降级到本地数据的情况：
- ❌ 云环境未初始化
- ❌ 集合不存在
- ❌ 权限不足
- ❌ 网络异常
- ❌ 查询超时

## 问题排查

### 常见问题1: "collection not exists"

**原因**: 云数据库集合未创建

**解决方案**:
1. 打开云开发控制台
2. 创建对应的集合（见上文）
3. 刷新小程序

### 常见问题2: "permission denied"

**原因**: 集合权限设置不正确

**解决方案**:
1. 进入集合权限设置
2. 选择「所有用户可读」
3. 保存并刷新

### 常见问题3: "云环境不存在"

**原因**: `wx.cloud.init()` 中的环境 ID 错误

**解决方案**:
1. 检查云控制台中的环境 ID
2. 更新 `src/App.vue` 中的配置
3. 重新编译小程序

### 常见问题4: 数据为空

**原因**: 集合中没有数据

**解决方案**:
1. 使用数据导入方法导入数据
2. 或者依赖本地 Mock 数据

### 常见问题5: 查询性能慢

**原因**: 缺少索引

**解决方案**:
1. 在集合中添加索引（见上文）
2. 优化查询条件

## 使用调试工具

### 内置调试页面

访问 `/pages/debug/index` 页面：

**功能**:
- ✅ 检查云环境状态
- ✅ 验证集合存在性
- ✅ 测试数据加载
- ✅ 显示错误详情

**使用方法**:
1. 在小程序中导航到调试页
2. 查看诊断结果
3. 根据提示解决问题

### 控制台日志

在微信开发者工具控制台查看详细日志：

**成功日志**:
```
✅ 云环境可用，环境ID: cloud1-xxx
📊 构建查询: 集合=cpu_collection, skip=0, limit=20
✅ 查询成功: 获取到 20 条数据
```

**错误日志**:
```
❌ 云数据库查询失败: collection not exists
⚠️ 降级到本地数据
```

## 性能优化

### 1. 分页查询

使用分页避免一次加载大量数据：

```typescript
const { list, loadMore } = useCloudData<CpuSpecs>({
  collectionName: 'cpu_collection',
  pageSize: 20  // 每页20条
})
```

### 2. 添加索引

在常用查询字段上添加索引：
- 提升查询速度
- 减少数据库负载
- 改善用户体验

### 3. 使用本地缓存

`useCloudData` 自动管理响应式缓存：
- 数据存储在 `ref` 中
- 页面返回时保留状态
- 减少重复请求

## 数据安全

### 权限控制

**推荐配置**:
```json
{
  "read": true,     // 所有用户可读
  "write": false    // 仅管理员可写
}
```

### 数据校验

在云函数中添加数据校验：
```javascript
// 示例：校验 CPU 数据
if (!data.id || !data.model || !data.brand) {
  return { error: '缺少必需字段' }
}
```

## 备份策略

### 本地备份

数据管道自动备份到 `skills/scripts/backups/`：
- 按日期组织（YYYYMMDD）
- 每次更新前自动备份
- 支持历史版本恢复

### 云端备份

在云控制台设置定期备份：
1. 进入云数据库设置
2. 启用自动备份
3. 设置备份频率

## 最佳实践

### 1. 开发环境

**使用本地 Mock 数据**:
- 快速开发调试
- 不依赖网络
- 数据可控

### 2. 测试环境

**使用测试云环境**:
- 独立的云环境 ID
- 测试数据与生产隔离
- 验证云功能

### 3. 生产环境

**使用生产云环境**:
- 完整的数据集
- 性能优化配置
- 监控和告警

## 监控与日志

### 云控制台监控

查看：
- 请求量统计
- 响应时间
- 错误率
- 存储使用量

### 错误追踪

在 `useCloudData` 中添加错误上报：
```typescript
catch (error) {
  console.error('数据加载失败:', error)
  // 可添加错误上报服务
}
```

## 相关文档

- [系统架构](../ARCHITECTURE.md) - 整体架构设计
- [项目状态](./PROJECT_STATUS.md) - 功能完成情况
- [数据管道文档](../scripts/README.md) - 数据更新流程

---

**支持的云环境**: 微信云开发  
**推荐配置**: 基础版（免费）即可满足需求  
**数据大小**: 约 100KB（全量数据）
quickDiagnosis()

// 或详细调试
wx.debugCloudDB.mainDebug()
```

## 📊 数据流说明

### 正常流程（云数据库可用）
```
用户请求 → 检查云环境 → 构建查询 → 云数据库 → 返回数据 → 页面显示
```

### 降级流程（云数据库不可用）
```
用户请求 → 检查云环境 → 云数据库失败 → 加载本地数据 → 页面显示 + 提示
```

## 🛠️ 技术实现细节

### 1. 云环境检测逻辑
```typescript
const isCloudSupported = computed(() => {
  // 1. 检查 wx 对象是否存在
  // 2. 检查 wx.cloud 是否存在
  // 3. 检查数据库实例是否可用
  // 4. 检查环境配置是否完整
})
```

### 2. 错误处理策略
```typescript
try {
  // 尝试云数据库查询
  const result = await query.get()
  return result.data
} catch (err) {
  // 识别错误类型
  if (isCollectionError || isPermissionError || isEnvError) {
    // 降级到本地数据
    return await loadLocalMockData()
  } else {
    // 显示错误提示
    showError(err.message)
  }
}
```

### 3. 本地数据降级
```typescript
const loadLocalMockData = async () => {
  // 根据集合名称加载对应的本地JSON文件
  // 应用相同的查询、排序、分页逻辑
  // 返回与云数据库相同格式的数据
}
```

## 📝 配置检查清单

### 必需配置
- [ ] 微信小程序已开通云开发
- [ ] 云环境ID已正确配置
- [ ] 数据库集合已创建
- [ ] 集合权限设置为"所有用户可读"

### 可选优化
- [ ] 导入测试数据到云数据库
- [ ] 配置数据库索引提升查询性能
- [ ] 设置数据缓存策略

## 🎯 验证修复效果

### 验证方法1: 查看页面显示
1. 打开小程序首页
2. 检查是否显示硬件数据
3. 切换CPU/GPU/手机分类
4. 测试搜索功能

### 验证方法2: 检查控制台输出
1. 打开微信开发者工具
2. 切换到控制台标签
3. 查看是否有错误信息
4. 确认看到详细的调试日志

### 验证方法3: 使用调试页面
1. 访问 `/pages/debug/index`
2. 运行各项检查
3. 查看诊断结果

## 🔄 备用方案

如果云数据库仍然无法访问，系统会自动降级到本地数据：

### 本地数据特点
- **数据来源**: `src/mock/` 目录下的JSON文件
- **数据量**: CPU(12条)、GPU(5条)、手机(5条)
- **功能支持**: 支持搜索、排序、分页
- **用户体验**: 显示"使用本地演示数据"提示

### 启用本地数据模式
```typescript
// 在 useCloudData.ts 中临时强制使用本地数据
const isCloudSupported = computed(() => {
  return false // 强制使用本地数据
})
```

## 📞 技术支持

### 常见问题解答

**Q: 页面完全不显示数据怎么办？**
A: 检查控制台错误信息，确认是否看到"使用本地演示数据"提示。

**Q: 如何确认云数据库是否配置正确？**
A: 访问调试页面或运行 `quickDiagnosis()`。

**Q: 本地数据和云数据有什么区别？**
A: 本地数据是静态JSON文件，云数据是动态数据库，功能完全一致。

**Q: 如何更新云数据库中的数据？**
A: 使用数据管道脚本 `scripts/update_db.py`。

### 获取更多帮助
1. 查看微信云开发官方文档
2. 检查项目中的 `README.md` 文件
3. 查看 `FILE_ANALYSIS.md` 了解文件功能
4. 运行测试脚本 `scripts/test_cloud_data.js`

## ✅ 修复总结

### 已解决的问题
1. ✅ 增强错误处理和调试信息
2. ✅ 修复TypeScript类型错误
3. ✅ 改进云环境检测逻辑
4. ✅ 优化本地数据降级策略
5. ✅ 添加详细的日志输出

### 预期效果
1. **云数据库可用时**: 正常显示云数据，控制台显示成功日志
2. **云数据库不可用时**: 自动降级到本地数据，显示提示信息
3. **开发调试时**: 详细的控制台日志便于问题排查

### 验证建议
1. 在微信开发者工具中测试
2. 查看控制台输出确认修复效果
3. 使用调试页面进行完整检查

---

**修复完成时间**: 2026年1月18日  
**修复版本**: v1.1.0  
**相关文件**: `src/composables/useCloudData.ts`  
**测试脚本**: `scripts/test_cloud_data.js`  
**使用指南**: 本文档
